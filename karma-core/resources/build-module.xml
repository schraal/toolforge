<?xml version="1.0" encoding="UTF-8"?>

<project name="karma" default="none">

  <target name="none">

    <!-- Nothing -->

  </target>

  <target name="init-build-dir">

    <!-- '${module-build-dir}' maps to ${development.home}/<manifest-name>/build/<module-name>-->
    <mkdir dir="${module-build-dir}"/>

  </target>

  <!-- ************************ -->
  <!-- build-module (bm)        -->
  <!-- ************************ -->

  <target name="build-module" depends="init-build-dir">

    <!-- '${module-build-dir}' maps to ${development.home}/<manifest-name>/build/<module-name>-->
    <!-- '${module-source-dir}' maps to ${development.home}/<manifest-name>/<module-name>/src/java-->
    <!-- '${compile-classpath}' is determined by Module.getDependencies -->

    <mkdir dir="${module-build-dir}/${module-compile-dir}"/>

    <!-- Remove the old jar file. -->
    <delete>
      <fileset dir="${module-build-dir}">
        <include name="*.jar"/>
      </fileset>
    </delete>

    <!-- <echo message="${module-classpath}"/> -->

    <javac
      destdir="${module-build-dir}/${module-compile-dir}"
      classpath="${module-classpath}"
      source="1.4"
      includes="**/*.java"
      compiler="modern"
      debug="true">

      <src path="${module-source-dir}"/>

    </javac>

  </target>

  <!-- ************************ -->
  <!-- test-module (tm)        -->
  <!-- ************************ -->

  <target name="test-module" depends="init-build-dir">

    <!-- '${module-build-dir}' maps to ${development.home}/<manifest-name>/build/<module-name>-->
    <!-- '${module-source-dir}' maps to ${development.home}/<manifest-name>/<module-name>/src/java-->
    <!-- '${compile-classpath}' is determined by Module.getDependencies -->

    <mkdir dir="${module-build-dir}/${module-test-dir}/xml"/>

    <javac
      destdir="${module-build-dir}/${module-test-dir}"
      srcdir="${module-source-dir}"
      classpath="${module-classpath}"
      debug="true"/>

    <!-- <echo message="classpath: ${module-classpath}:${module-build-dir}/${module-test-dir}:${module-source-dir}/../resources"/> -->

    <available property="excludes-file-present" file="${module-source-dir}/excludes.properties"/>
    <junit
      printsummary="yes"
      showoutput="yes"
      fork="no"
      errorproperty="unittestsfailed"
      failureproperty="unittestsfailed"
      reloading="false">

      <!-- todo: pad moet anders -->
      <classpath>
        <pathelement path="${module-classpath}:${module-build-dir}/${module-test-dir}:${module-source-dir}/../resources:${module-source-dir}/../../resources"/>
      </classpath>

      <formatter type="xml"/>

      <batchtest todir="${module-build-dir}/${module-test-dir}/xml">
        <fileset dir="${module-source-dir}">
          <include name="**/*.java"/>
          <excludesfile name="${module-source-dir}/excludes.properties" if="excludes-file-present"/>
        </fileset>
      </batchtest>
    </junit>
    <fail message="Tests failed." if="unittestsfailed"/>
    
  </target>

  <!-- *********************************************************** -->
  <!-- clean-module (clm); removes build and test stuff of module  -->
  <!-- *********************************************************** -->

  <target name="clean-module">
    <delete dir="${module-build-dir}" />
  </target>

  <!-- ************************************************************* -->
  <!-- clean-all (cla); removes build and test stuff of all modules  -->
  <!-- ************************************************************* -->

  <target name="clean-all">
    <delete dir="${manifest-build-dir}" />
  </target>

  <!-- *************************************** -->
  <!-- package-module (pa); resulting in a jar -->
  <!-- *************************************** -->

  <target name="package-module-as-jar" depends="init-build-dir">

    <!-- Remove all jar-files -->
    <delete dir="${module-build-dir}" includes="*.jar"/>

    <!-- <echo message="${module-build-dir}, ${module-base-dir}, ${module-includes}"/> -->

    <!-- copy resources from the module src to the package dir -->
    <!-- todo: refactor this so it works in a proper way. I really hate myself -->
    <copy todir="${module-build-dir}/${module-package-dir}" overwrite="true">
      <fileset dir="${module-base-dir}/resources" includes="**/*"/>
    </copy>
    <copy todir="${module-build-dir}/${module-package-dir}" overwrite="true">
      <fileset dir="${module-base-dir}" includes="${module-includes}" excludes="resources"/>
    </copy>

    <!-- copy resources from the module build to the package dir -->
    <copy todir="${module-build-dir}/${module-package-dir}" overwrite="true">
      <fileset dir="${module-build-dir}/${module-compile-dir}" includes="**/*.class"/>
    </copy>

    <!-- todo: the /.. needs to be configured -->
    <jar
      destfile="${module-package-name}"
      basedir="${module-build-dir}/${module-package-dir}"
      excludes="${module-excludes}"
      />

  </target>

  <!-- *************************************** -->
  <!-- package-module (pa); resulting in a war -->
  <!-- *************************************** -->

  <target name="package-module-as-war" depends="init-build-dir">

    <delete>
      <fileset dir="${module-build-dir}" includes="*.war"/>
    </delete>

    <copy todir="${module-build-dir}/${module-package-dir}" overwrite="true">
      <fileset dir="${module-base-dir}/web" includes="**/*"/>
    </copy>
    <copy todir="${module-build-dir}/${module-package-dir}" overwrite="true">
      <fileset dir="${module-base-dir}" includes="${module-includes}" excludes="web"/>
    </copy>

    <!-- For standalone wars, all deps are copied to WEB-INF/lib and packaged as such.-->

    <echo message="${manifest-build-dir} - ${module-module-dependencies}"/>
    <echo message="${karma-jar-repository} - ${module-jar-dependencies}"/>
    <copy todir="${module-build-dir}/${module-package-dir}/WEB-INF/lib" flatten="yes" >

      <!-- Module dependencies, appear as <dependency module=""/> -->
      <fileset dir="${manifest-build-dir}" includes="${module-module-dependencies}"/>
      <!-- Jar dependencies, from the jar-repository -->
      <fileset dir="${karma-jar-repository}" includes="${module-jar-dependencies}"/>
    </copy>

    <!-- Package the module -->

    <war destfile="${module-package-name}" basedir="${module-build-dir}/${module-package-dir}" webxml="${module-webxml}"/>

  </target>

  <!-- *************************************** -->
  <!-- package-module (pa); resulting in an ear -->
  <!-- *************************************** -->

  <target name="package-module-as-ear" depends="init-build-dir">

    <delete dir="${module-build-dir}" includes="*.ear;archives.*"/>

    <!-- copy the eapp stuff, while replacing module ids in application.xml -->
    <copy todir="${module-build-dir}/${module-package-dir}" overwrite="true">
      <fileset dir="${module-base-dir}" includes="${module-includes}"/>
      <filterset>
        <filtersfile file="${module-build-dir}/archives.properties"/>
      </filterset>
    </copy>

    <!-- copy the external jars and wars-->
    <copy todir="${module-build-dir}/${module-package-dir}" flatten="yes">
      <fileset dir="${module-build-dir}" includesfile="${module-build-dir}/archives.includes"/>
    </copy>

    <ear
      destfile="${module-package-name}"
      basedir="${module-build-dir}/${module-package-dir}"
      appxml="${module-appxml}"
      excludes="${module-excludes}"
      />

  </target>

</project>